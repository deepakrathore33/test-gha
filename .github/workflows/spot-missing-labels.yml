name: "Spot Issues Missing Area Labels"

on:
  workflow_dispatch:
  schedule:
    - cron: '0 13 * * *'

permissions:
  issues: write
  contents: read

jobs:
  check-area-labels:
    name: "Check Issues Missing Area Labels"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Add 'needs-area-label' to Issues Missing Area Labels
        uses: actions/github-script@v6
        with:
          script: |
            const AREA_LABEL_PREFIX = 'Area-';
            const DEFAULT_LABEL = 'needs-area-label';

            const issues = await github.paginate(github.rest.issues.listForRepo, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100,
            });

            const noLabelsOrAssignees = issues.filter(issue => {
              const hasUntriagedLabel = issue.labels.some(label => label.name === 'untriaged');
              const hasAreaCompilersLabel = issue.labels.some(label => label.name === 'Area-Compilers');
              return hasUntriagedLabel && !hasAreaCompilersLabel && !issue.assignee;
            });

            for (const issue of noLabelsOrAssignees) {
              // Skip pull requests
              if (issue.pull_request) continue;

              // Ensure labels property exists and is an array
              const labels = issue.labels || [];
              const hasAreaLabel = labels.some(label => label.name.startsWith(AREA_LABEL_PREFIX));
              const hasNeedsLabel = labels.includes(DEFAULT_LABEL);

              if (!hasAreaLabel && !hasNeedsLabel) {
                console.log(`Adding '${DEFAULT_LABEL}' to issue #${issue.number}`);
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  labels: [DEFAULT_LABEL],
                });
              }
            }
